Niektóre z poniższych ćwiczeń wykorzystują wektor (`zion_points`) i zbiór danych rastrowych (`srtm`) zpakietu**spDataLarge**.
Wykorzystują one również wielokątną „obwiednię wypukłą” pochodzącą ze zbioru danych wektorowych (`ch`) w celu przedstawienia obszaru zainteresowania:

```{r 06-ex-e0, message=FALSE, include=TRUE}
library(sf)
library(terra)
library(spData)
zion_points_path = system.file("vector/zion_points.gpkg", package = "spDataLarge")
zion_points = read_sf(zion_points_path)
srtm = rast(system.file("raster/srtm.tif", package = "spDataLarge"))
ch = st_combine(zion_points) |>
  st_convex_hull() |> 
  st_as_sf()
```

E1. Przytnijraster`srtm`, korzystając z (1)zbioru danych`zion_points`oraz (2)zbioru danych`ch`.
Czy istnieją jakieś różnice w mapach wyjściowych?
Następnie zamaskuj`srtm`,korzystając z tych dwóch zbiorów danych.
Czy widzisz teraz jakąś różnicę?
Jak można to wyjaśnić?

```{r 06-ex-e1}
plot(srtm)
plot(st_geometry(zion_points), add = TRUE)
plot(ch, add = TRUE)

srtm_crop1 = crop(srtm, zion_points)
srtm_crop2 = crop(srtm, ch)
plot(srtm_crop1)
plot(srtm_crop2)

srtm_mask1 = mask(srtm, zion_points)
srtm_mask2 = mask(srtm, ch)
plot(srtm_mask1)
plot(srtm_mask2)
```

E2. Najpierw wyodrębnij wartości z`srtm`w punktach przedstawionych w`zion_points`.
Następnie wyodrębnij średnie wartości z`srtm`,używając bufora 90 wokół każdego punktu z`zion_points`i porównaj te dwa zestawy wartości.
Kiedy wyodrębnianie wartości za pomocą buforów jest bardziej odpowiednie niż wyodrębnianie wartości wyłącznie za pomocą punktów?

- Dodatkowe zadanie: Zaimplementuj wyodrębnianie za pomocąpakietu**exactextractr**i porównaj wyniki.

```{r 06-ex-e2}
zion_points_buf = st_buffer(zion_points, dist = 90)
plot(srtm)
plot(st_geometry(zion_points_buf), add = TRUE)
plot(ch, add = TRUE)

zion_points_points = extract(srtm, zion_points)
zion_points_buffer = extract(srtm, zion_points_buf, fun = "mean")
plot(zion_points_points$srtm, zion_points_buffer$srtm)

# Bonus
# remotes::install_github("isciences/exactextractr")
# zion_points_buf_2 = exactextractr::exact_extract(x = srtm, y = zion_points_buf,
#                                                  fun = "mean")
# 
# plot(zion_points_points$srtm, zion_points_buf_2)
# plot(zion_points_buffer$srtm, zion_points_buf_2)
```

E3. Wybierz podzbiór punktów powyżej 3100 metrów w Nowej Zelandii (obiekt`nz_height`) i utwórz szablon rastrowej mapy o rozdzielczości 3 km dla zakresu nowego zbioru danych punktowych.
Korzystając z tych dwóch nowych obiektów:

- policz liczbę najwyższych punktów w każdej komórce siatki.
- Znajdź maksymalną wysokość w każdej komórce siatki.

```{r 06-ex-e3}
nz_height3100 = dplyr::filter(nz_height, elevation > 3100)
new_graticule = st_graticule(nz_height3100, datum = "EPSG:2193")
plot(st_geometry(nz_height3100), graticule = new_graticule, axes = TRUE)

nz_template = rast(ext(nz_height3100), resolution = 3000, crs = crs(nz_height3100))

nz_raster = rasterize(nz_height3100, nz_template, 
                      field = "elevation", fun = "length")
plot(nz_raster)
plot(st_geometry(nz_height3100), add = TRUE)

nz_raster2 = rasterize(nz_height3100, nz_template, 
                       field = "elevation", fun = max)
plot(nz_raster2)
plot(st_geometry(nz_height3100), add = TRUE)
```

E4. Zsumuj punkty o najwyższej wartości w rastrowej mapie Nowej Zelandii (utworzonej w poprzednim ćwiczeniu), zmniejsz jej rozdzielczość geograficzną o połowę (tak, aby komórki miały wymiary 6 x 6 km) i narysuj wynik.

- Próbkuj ponownie raster o niższej rozdzielczości do pierwotnej rozdzielczości 3 km. Jak zmieniły się wyniki?
- Wymień dwie zalety i dwie wady zmniejszenia rozdzielczości rastra.

```{r 06-ex-e4}
nz_raster_low = raster::aggregate(nz_raster, fact = 2, fun = sum, na.rm = TRUE)
res(nz_raster_low)

nz_resample = resample(nz_raster_low, nz_raster)
plot(nz_raster_low)
plot(nz_resample) # the results are spread over a greater area and there are border issues
plot(nz_raster)
```

```{asis 06-ex-e4-asis}
Advantages:

- lower memory use
- faster processing
- good for viz in some cases

Disadvantages:

- removes geographic detail
- adds another processing step
```

E5. Poligonizuj zbiórdanych`grain`i odfiltruj wszystkie kwadraty reprezentujące glinę.

```{r 06-ex-e5}
grain = rast(system.file("raster/grain.tif", package = "spData"))
```

- Wymień dwie zalety i wady danych wektorowych w porównaniu z danymi rastrowymi.
- Kiedy w Twojej pracy przydatna byłaby konwersja danych rastrowych na wektorowe?

```{r 06-ex-e5-2}
grain_poly = as.polygons(grain) |> 
  st_as_sf()
levels(grain)
clay = dplyr::filter(grain_poly, grain == "clay")
plot(clay)
```

```{asis 06-ex-e5-2-asis}
Advantages: 

- can be used to subset other vector objects
- can do affine transformations and use sf/dplyr verbs

Disadvantages: 

- better consistency
- fast processing on some operations
- functions developed for some domains
```


